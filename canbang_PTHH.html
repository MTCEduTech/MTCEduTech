<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Cân bằng phương trình hóa học</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; text-align: center; background: #eef4fa; }
    input { width: 460px; padding: 10px; font-size: 16px; }
    button { padding: 5px 10px; margin: 2px; font-size: 16px; cursor: pointer; }
    #result { margin-top: 20px; font-size: 18px; font-weight: bold; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>Cân bằng phương trình hóa học</h2>
  
  <!-- Thanh phím -->
  <div>
    <span>Chèn: </span>
    <button onclick="insertSub('₁')">₁</button>
    <button onclick="insertSub('₂')">₂</button>
    <button onclick="insertSub('₃')">₃</button>
    <button onclick="insertSub('₄')">₄</button>
    <button onclick="insertSub('₅')">₅</button>
    <button onclick="insertSub('₆')">₆</button>
    <button onclick="insertSub('₇')">₇</button>
    <button onclick="insertSub('₈')">₈</button>
    <button onclick="insertSub('₉')">₉</button>
    <button onclick="insertSub('₀')">₀</button>
    <button onclick="insertSub('(')">(</button>
    <button onclick="insertSub(')')">)</button>
    <button onclick="insertSub(' → ')">→</button>
  </div>

  <input id="inputEq" placeholder="VD: Fe₂(SO₄)₃ + BaCl₂ → FeCl₃ + BaSO₄" />
  <br>
  <button onclick="balance()">Cân bằng</button>
  <div id="result"></div>

  <script>
    function insertSub(symbol) {
      const input = document.getElementById("inputEq");
      const start = input.selectionStart;
      const end = input.selectionEnd;
      const text = input.value;
      input.value = text.slice(0, start) + symbol + text.slice(end);
      input.focus();
      input.selectionStart = input.selectionEnd = start + symbol.length;
    }

    function normalizeFormula(formula) {
      const subDigits = { '₀':'0','₁':'1','₂':'2','₃':'3','₄':'4','₅':'5','₆':'6','₇':'7','₈':'8','₉':'9' };
      return formula.replace(/[₀₁₂₃₄₅₆₇₈₉]/g, m => subDigits[m]);
    }

    function parseFormula(formula) {
      formula = normalizeFormula(formula);
      const tokens = formula.match(/([A-Z][a-z]?|\(|\)|\d+)/g);
      const stack = [{}];
      let i = 0;
      while (i < tokens.length) {
        const t = tokens[i];
        if (t === '(') {
          stack.push({});
          i++;
        } else if (t === ')') {
          const group = stack.pop();
          i++;
          const mul = /^\d+$/.test(tokens[i]) ? parseInt(tokens[i++]) : 1;
          for (const el in group) {
            stack[stack.length - 1][el] = (stack[stack.length - 1][el] || 0) + group[el] * mul;
          }
        } else if (/^[A-Z][a-z]?$/.test(t)) {
          const el = t;
          const count = /^\d+$/.test(tokens[i + 1]) ? parseInt(tokens[++i]) : 1;
          i++;
          stack[stack.length - 1][el] = (stack[stack.length - 1][el] || 0) + count;
        } else {
          i++;
        }
      }
      return stack[0];
    }

    function gcd(a, b) {
      return b === 0 ? a : gcd(b, a % b);
    }

    function lcm(a, b) {
      return Math.abs(a * b) / gcd(a, b);
    }

    function lcmArray(arr) {
      return arr.reduce((acc, val) => lcm(acc, val), 1);
    }

    function balance() {
      const input = document.getElementById("inputEq").value.trim();
      const [lhs, rhs] = input.replace(/→|=>/g, '=').split('=').map(s => s.trim());

      if (!lhs || !rhs) {
        document.getElementById("result").innerText = "Vui lòng nhập phương trình đúng định dạng!";
        return;
      }

      const left = lhs.split('+').map(s => s.trim());
      const right = rhs.split('+').map(s => s.trim());
      const all = [...left, ...right];
      const elements = Array.from(new Set(all.flatMap(m => Object.keys(parseFormula(m)))));
      
      const matrix = elements.map(el =>
        all.map((mol, i) => {
          const atomCount = parseFormula(mol)[el] || 0;
          return i < left.length ? atomCount : -atomCount;
        })
      );

      const A = numeric.transpose(matrix);
      const svd = numeric.svd(A);
      const nullSpaceVec = svd.V[svd.V.length - 1];
      const scale = lcmArray(nullSpaceVec.map(v => {
        const decimals = (v.toString().split('.')[1] || '').length;
        return Math.pow(10, decimals);
      }));

      let coeffs = nullSpaceVec.map(v => Math.round(v * scale));
      const gcdAll = coeffs.reduce((a, b) => gcd(a, b));
      coeffs = coeffs.map(v => v / gcdAll);
      if (coeffs.some(c => c < 0)) coeffs = coeffs.map(c => -c);

      const leftStr = coeffs.slice(0, left.length).map((c, i) => (c === 1 ? '' : c) + left[i]).join(' + ');
      const rightStr = coeffs.slice(left.length).map((c, i) => (c === 1 ? '' : c) + right[i]).join(' + ');

      document.getElementById("result").innerText = leftStr + ' → ' + rightStr;
    }
  </script>
</body>
</html>
