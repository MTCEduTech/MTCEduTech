<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Cân bằng phương trình hóa học</title>
  <script src="https://cdn.jsdelivr.net/npm/mathjs@11.8.0/lib/browser/math.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; text-align: center; background: #eef4fa; }
    input { width: 450px; padding: 10px; font-size: 16px; }
    button { padding: 8px 16px; font-size: 16px; margin-top: 10px; }
    #result { margin-top: 20px; font-size: 18px; font-weight: bold; color: #333; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>Cân bằng phương trình hóa học</h2>
  <input id="inputEq" placeholder="VD: Fe2(SO4)3 + BaCl2 → FeCl3 + BaSO4" />
  <br />
  <button onclick="balance()">Cân bằng</button>
  <div id="result"></div>

  <script>
    // Hàm phân tích công thức hóa học thành đối tượng {Nguyên tố: số lượng}
    function parseFormula(formula) {
      const tokens = formula.match(/([A-Z][a-z]?|\(|\)|\d+)/g);
      if (!tokens) return {};
      const stack = [{}];
      let i = 0;
      while (i < tokens.length) {
        const t = tokens[i];
        if (t === '(') {
          stack.push({});
          i++;
        } else if (t === ')') {
          const group = stack.pop();
          i++;
          let mul = 1;
          if (i < tokens.length && /^\d+$/.test(tokens[i])) {
            mul = parseInt(tokens[i]);
            i++;
          }
          for (const el in group) {
            stack[stack.length - 1][el] = (stack[stack.length - 1][el] || 0) + group[el] * mul;
          }
        } else if (/^[A-Z][a-z]?$/.test(t)) {
          const el = t;
          i++;
          let count = 1;
          if (i < tokens.length && /^\d+$/.test(tokens[i])) {
            count = parseInt(tokens[i]);
            i++;
          }
          stack[stack.length - 1][el] = (stack[stack.length - 1][el] || 0) + count;
        } else {
          i++;
        }
      }
      return stack[0];
    }

    function gcd(a, b) {
      return b === 0 ? a : gcd(b, a % b);
    }

    function balance() {
      const input = document.getElementById("inputEq").value.trim();
      const resultDiv = document.getElementById("result");
      if (!input) {
        resultDiv.innerText = "Vui lòng nhập phương trình.";
        return;
      }

      // Tách 2 vế bằng dấu → hoặc =
      const sides = input.replace(/→|=>/g, '=').split('=');
      if (sides.length !== 2) {
        resultDiv.innerText = "Sai cú pháp. Phải có một dấu → hoặc = giữa phản ứng.";
        return;
      }

      const lhs = sides[0].trim();
      const rhs = sides[1].trim();

      if (!lhs || !rhs) {
        resultDiv.innerText = "Thiếu phản ứng hoặc sản phẩm.";
        return;
      }

      const left = lhs.split('+').map(x => x.trim());
      const right = rhs.split('+').map(x => x.trim());
      const allMols = [...left, ...right];

      // Lấy danh sách nguyên tố
      const elements = Array.from(new Set(allMols.flatMap(m => Object.keys(parseFormula(m)))));
      if (elements.length === 0) {
        resultDiv.innerText = "Không tìm thấy nguyên tố hợp lệ.";
        return;
      }

      // Tạo ma trận hệ số
      const matrix = elements.map(el =>
        allMols.map((mol, i) => (i < left.length ? parseFormula(mol)[el] || 0 : -(parseFormula(mol)[el] || 0)))
      );

      const A = math.matrix(matrix);

      // Tính không gian nullspace (giải hệ Ax=0)
      const ns = math.nullSpace(A);
      if (ns.size()[1] === 0) {
        resultDiv.innerText = "Không thể cân bằng phương trình.";
        return;
      }

      // Lấy vector đầu tiên trong nullspace
      let solution = ns.subset(math.index(math.range(0, ns.size()[0]), 0)).toArray();

      // Chuyển thành phân số và tìm mẫu chung
      const fractions = solution.map(x => math.fraction(x));
      const denominators = fractions.map(f => f.d);
      let commonDenominator = denominators.reduce((a, b) => (b === 0 ? a : (a * b) / gcd(a, b)));

      // Tính hệ số nguyên
      let coeffs = fractions.map(f => Math.round(f.n * (commonDenominator / f.d)));

      // Rút gọn hệ số
      const gcdAll = coeffs.reduce((a, b) => gcd(a, b));
      coeffs = coeffs.map(c => c / gcdAll);

      // Kiểm tra hệ số âm, đổi dấu nếu cần
      if (coeffs.some(c => c < 0)) {
        coeffs = coeffs.map(c => -c);
      }

      const leftCoeffs = coeffs.slice(0, left.length);
      const rightCoeffs = coeffs.slice(left.length);

      const leftStr = leftCoeffs
        .map((c, i) => (c === 1 ? left[i] : c + left[i]))
        .join(' + ');
      const rightStr = rightCoeffs
        .map((c, i) => (c === 1 ? right[i] : c + right[i]))
        .join(' + ');

      resultDiv.innerText = `${leftStr} → ${rightStr}`;
    }
  </script>
</body>
</html>
