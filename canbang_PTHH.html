<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Cân bằng phương trình hóa học</title>
  <!-- Tải các thư viện theo đúng thứ tự -->
  <script src="https://unpkg.com/nerdamer/nerdamer.core.js"></script>
  <script src="https://unpkg.com/nerdamer/Algebra.js"></script>
  <script src="https://unpkg.com/nerdamer/Solve.js"></script>
  <script src="https://unpkg.com/mathjs@11.11.1/lib/browser/math.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #eef4fa; text-align: center; }
    input { width: 450px; padding: 10px; font-size: 16px; }
    button { padding: 8px 20px; margin-top: 10px; font-size: 16px; }
    #result { margin-top: 20px; font-size: 18px; font-weight: bold; color: #333; }
  </style>
</head>
<body>
  <h2>Cân bằng phương trình hóa học</h2>
  <input id="inputEq" placeholder="VD: Fe2(SO4)3 + BaCl2 → FeCl3 + BaSO4">
  <br>
  <button onclick="balance()">Cân bằng</button>
  <div id="result"></div>

<script>
function parseFormula(formula) {
  const stack = [{}];
  const tokens = formula.match(/([A-Z][a-z]?|\(|\)|\d+)/g);
  let i = 0;
  while (i < tokens.length) {
    const token = tokens[i];
    if (token === '(') {
      stack.push({});
      i++;
    } else if (token === ')') {
      const group = stack.pop();
      i++;
      const multiplier = /^\d+$/.test(tokens[i]) ? parseInt(tokens[i]) : 1;
      if (/^\d+$/.test(tokens[i])) i++;
      for (const el in group) {
        stack[stack.length - 1][el] = (stack[stack.length - 1][el] || 0) + group[el] * multiplier;
      }
    } else if (/^[A-Z][a-z]?$/.test(token)) {
      const el = token;
      i++;
      const count = /^\d+$/.test(tokens[i]) ? parseInt(tokens[i]) : 1;
      if (/^\d+$/.test(tokens[i])) i++;
      stack[stack.length - 1][el] = (stack[stack.length - 1][el] || 0) + count;
    } else i++;
  }
  return stack[0];
}

function gcd(a, b) {
  return b ? gcd(b, a % b) : Math.abs(a);
}

function lcm(a, b) {
  return Math.abs(a * b) / gcd(a, b);
}

function lcmArr(arr) {
  return arr.reduce((a, b) => lcm(a, b));
}

function balance() {
  const input = document.getElementById("inputEq").value.trim();
  const [lhs, rhs] = input.replace(/→|=>/g, '=').split("=").map(s => s.trim());
  if (!lhs || !rhs) return document.getElementById("result").innerText = "Sai cú pháp.";

  const left = lhs.split('+').map(s => s.trim());
  const right = rhs.split('+').map(s => s.trim());
  const all = [...left, ...right];
  const matrix = [];
  const elements = Array.from(new Set(all.flatMap(m => Object.keys(parseFormula(m)))));

  for (const el of elements) {
    const row = all.map((mol, i) => {
      const count = parseFormula(mol)[el] || 0;
      return i < left.length ? count : -count;
    });
    matrix.push(row);
  }

  const A = math.matrix(matrix);
  const nullspace = math.nullSpace(A);

  if (nullspace._size[1] === 0) {
    document.getElementById("result").innerText = "Không thể cân bằng.";
    return;
  }

  let sol = nullspace._data.map(row => row[0]);
  const denoms = sol.map(x => math.fraction(x).d);
  const multiplier = lcmArr(denoms);
  let coeffs = sol.map(x => math.multiply(x, multiplier)).map(x => math.number(x));

  const leftStr = coeffs.slice(0, left.length).map((c, i) => `${c}${left[i]}`).join(" + ");
  const rightStr = coeffs.slice(left.length).map((c, i) => `${c}${right[i]}`).join(" + ");

  document.getElementById("result").innerText = `${leftStr} → ${rightStr}`;
}
</script>

<script>
  // Hàm rút gọn các hệ số về dạng nguyên tố nhỏ nhất
  function reduceCoeffs(arr) {
    function gcdTwo(a, b) {
      return b === 0 ? a : gcdTwo(b, a % b);
    }
    let g = 0;
    for (const v of arr) {
      if (v !== 0) g = g === 0 ? Math.abs(v) : gcdTwo(g, Math.abs(v));
    }
    if (g === 0) g = 1;
    return arr.map(x => x / g);
  }

  function balance() {
    const input = document.getElementById("inputEq").value.trim();
    if (!input) {
      document.getElementById("result").innerText = "Vui lòng nhập phương trình.";
      return;
    }

    // Chuẩn hóa dấu mũi tên
    const sides = input.replace(/→|=>/g, '=').split('=');
    if (sides.length !== 2) {
      document.getElementById("result").innerText = "Sai cú pháp. Phải có một dấu → hoặc = giữa phản ứng.";
      return;
    }
    const lhs = sides[0].trim();
    const rhs = sides[1].trim();
    if (!lhs || !rhs) {
      document.getElementById("result").innerText = "Thiếu phản ứng hoặc sản phẩm.";
      return;
    }

    const left = lhs.split('+').map(x => x.trim());
    const right = rhs.split('+').map(x => x.trim());
    const allMols = [...left, ...right];

    // Lấy danh sách nguyên tố
    const elements = Array.from(new Set(allMols.flatMap(m => Object.keys(parseFormula(m)))));
    if (elements.length === 0) {
      document.getElementById("result").innerText = "Không tìm thấy nguyên tố hợp lệ.";
      return;
    }

    // Tạo ma trận hệ số nguyên tố
    const matrix = elements.map(el =>
      allMols.map((mol, i) => (i < left.length ? parseFormula(mol)[el] || 0 : -(parseFormula(mol)[el] || 0)))
    );

    const A = math.matrix(matrix);

    // Tính không gian null (nghiệm tự do)
    const ns = math.nullSpace(A);
    if (ns._size[1] === 0) {
      document.getElementById("result").innerText = "Không thể cân bằng phương trình.";
      return;
    }

    // Lấy nghiệm (cột đầu tiên của nullspace)
    let solution = ns._data.map(row => row[0]);

    // Tìm bội chung nhỏ nhất để chuyển về số nguyên
    const denominators = solution.map(x => math.fraction(x).d);
    const commonDenom = denominators.reduce((a, b) => (b === 0 ? a : (a * b) / gcd(a, b)));

    let coeffs = solution.map(x => Math.round(x * commonDenom));

    // Rút gọn các hệ số
    coeffs = reduceCoeffs(coeffs);

    // Chuẩn bị kết quả hiển thị
    const leftCoeffs = coeffs.slice(0, left.length);
    const rightCoeffs = coeffs.slice(left.length);

    // Hiển thị dạng chuẩn: 1 không hiện, >1 hiện rõ
    const leftStr = leftCoeffs
      .map((c, i) => (c === 1 ? left[i] : c + left[i]))
      .join(' + ');
    const rightStr = rightCoeffs
      .map((c, i) => (c === 1 ? right[i] : c + right[i]))
      .join(' + ');

    document.getElementById("result").innerText = `${leftStr} → ${rightStr}`;
  }
</script>
</body>
</html>

