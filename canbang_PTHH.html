<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Cân bằng PTHH – numeric.js</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #eef4fa; text-align: center; }
    input { width: 460px; padding: 8px; font-size: 16px; }
    button { margin: 4px; font-size: 16px; padding: 6px 10px; cursor: pointer; }
    #result { margin-top: 20px; font-size: 18px; font-weight: bold; white-space: pre-wrap; }
  </style>
</head>
<body>

<h2>Cân bằng phương trình hóa học</h2>
<div>
  <button onclick="insert('₁')">₁</button><button onclick="insert('₂')">₂</button><button onclick="insert('₃')">₃</button>
  <button onclick="insert('₄')">₄</button><button onclick="insert('₅')">₅</button><button onclick="insert('₆')">₆</button>
  <button onclick="insert('₇')">₇</button><button onclick="insert('₈')">₈</button><button onclick="insert('₉')">₉</button>
  <button onclick="insert('₀')">₀</button><button onclick="insert('(')">(</button><button onclick="insert(')')">)</button>
  <button onclick="insert(' + ')">+</button><button onclick="insert(' → ')">→</button>
</div>

<input id="inputEq" placeholder="Ví dụ: Fe₂(SO₄)₃ + BaCl₂ → FeCl₃ + BaSO₄" />
<br>
<button onclick="balance()">Cân bằng</button>

<div id="result"></div>

<script>
function insert(txt){
  const i = document.getElementById('inputEq');
  const s=i.selectionStart, e=i.selectionEnd;
  i.value = i.value.slice(0,s)+txt+i.value.slice(e);
  i.selectionStart=i.selectionEnd=s+txt.length;
  i.focus();
}
function normalize(s){
  const map={'₀':'0','₁':'1','₂':'2','₃':'3','₄':'4','₅':'5','₆':'6','₇':'7','₈':'8','₉':'9'};
  return s.replace(/[₀-₉]/g,c=>map[c]);
}
function parseFormula(f){
  f=normalize(f);
  const tokens=f.match(/([A-Z][a-z]?|\d+|\(|\))/g);
  const stack=[{}];
  for(let i=0;i<tokens.length;){
    const t=tokens[i];
    if(t==='('){stack.push({});i++;}
    else if(t===')'){
      const g=stack.pop();i++;
      const mul=i<tokens.length&&/^\d+$/.test(tokens[i])?+tokens[i]++:1;
      const top=stack[stack.length-1];
      for(let k in g) top[k]=(top[k]||0)+g[k]*mul;
    } else if(/^[A-Z]/.test(t)){
      const el=t;
      let cnt=1;
      if(i+1<tokens.length&&/^\d+$/.test(tokens[i+1])) cnt=+tokens[++i];
      stack[stack.length-1][el]=(stack[stack.length-1][el]||0)+cnt;
      i++;
    } else i++;
  }
  return stack[0];
}
function gcd(a,b){return b?gcd(b,a%b):a;}
function lcm(a,b){return a*b/gcd(a,b);}
function balance(){
  const inp=document.getElementById('inputEq').value;
  if(!/(→|=>|=)/.test(inp)){document.getElementById('result').innerText='Thiếu dấu →'; return;}
  const [L,R]=inp.replace(/=>/g,'→').split(/→|=/).map(s=>s.trim());
  const left=L.split('+').map(s=>s.trim()), right=R.split('+').map(s=>s.trim());
  const all=[...left,...right];
  const elems=Array.from(new Set(all.flatMap(m=>Object.keys(parseFormula(m)))));
  const mat=elems.map(el=>all.map((m,i)=>parseFormula(m)[el]||(0))*((i<left.length)?1:-1));
  const A=numeric.transpose(mat);
  const svd=numeric.svd(A);
  const ns=svd.V[svd.V.length-1];
  const dens=ns.map(x=>Math.pow(10,(x.toString().split('.')[1]||'').length));
  const scale=dens.reduce((a,b)=>lcm(a,b),1);
  let coeffs=ns.map(x=>Math.round(x*scale));
  const g=coeffs.reduce((a,b)=>gcd(a,b));
  coeffs=coeffs.map(v=>v/g);
  if(coeffs.some(v=>v<0)) coeffs=coeffs.map(v=>-v);
  const leftRes=left.map((m,i)=>coeffs[i]>1?coeffs[i]+m:m).join(' + ');
  const rightRes=right.map((m,i)=>coeffs[i+left.length]>1?coeffs[i+left.length]+m:m).join(' + ');
  document.getElementById('result').innerText=leftRes+' → '+rightRes;
}
</script>
</body>
</html>
