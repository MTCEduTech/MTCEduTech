<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Cân bằng phương trình hóa học</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/nerdamer/1.1.13/nerdamer.core.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/nerdamer/1.1.13/Algebra.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/nerdamer/1.1.13/Solve.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; text-align: center; background: #eef4fa; }
    input { width: 450px; padding: 10px; font-size: 16px; }
    button { padding: 8px 16px; font-size: 16px; margin-top: 10px; }
    #result { margin-top: 20px; font-size: 18px; font-weight: bold; color: #333; }
  </style>
</head>
<body>
  <h2>Cân bằng phương trình hóa học</h2>
  <input id="inputEq" placeholder="VD: Fe2(SO4)3 + BaCl2 → FeCl3 + BaSO4">
  <br>
  <button onclick="balance()">Cân bằng</button>
  <div id="result"></div>

  <script>
    function parseFormula(formula) {
      const tokens = formula.match(/([A-Z][a-z]?|\(|\)|\d+)/g);
      const stack = [{}];
      let i = 0;
      while (i < tokens.length) {
        const t = tokens[i];
        if (t === "(") {
          stack.push({}); i++;
        } else if (t === ")") {
          const group = stack.pop();
          const mul = /^\d+$/.test(tokens[i + 1]) ? parseInt(tokens[++i]) : 1;
          for (const el in group) {
            stack[stack.length - 1][el] = (stack[stack.length - 1][el] || 0) + group[el] * mul;
          }
          i++;
        } else if (/^[A-Z][a-z]?$/.test(t)) {
          const el = t;
          const count = /^\d+$/.test(tokens[i + 1]) ? parseInt(tokens[++i]) : 1;
          stack[stack.length - 1][el] = (stack[stack.length - 1][el] || 0) + count;
          i++;
        } else i++;
      }
      return stack[0];
    }

    function gcd(a, b) {
      return b ? gcd(b, a % b) : Math.abs(a);
    }
    function lcmArr(arr) {
      return arr.reduce((a, b) => a * b / gcd(a, b));
    }
    function gcdArr(arr) {
      return arr.reduce((a, b) => gcd(a, b));
    }

    function balance() {
      const input = document.getElementById("inputEq").value.trim();
      const [lhs, rhs] = input.replace(/\u2192/g, '=').split("=").map(s => s.trim());
      if (!lhs || !rhs) return document.getElementById("result").innerText = "Sai cú pháp.";

      const left = lhs.split('+').map(s => s.trim());
      const right = rhs.split('+').map(s => s.trim());
      const all = [...left, ...right];
      const vars = all.map((_, i) => 'x' + (i + 1));
      const elems = Array.from(new Set(all.flatMap(mol => Object.keys(parseFormula(mol)))));

      const equations = elems.map(el => {
        return all.map((mol, i) => {
          const n = parseFormula(mol)[el] || 0;
          return (i < left.length ? n : -n) + '*' + vars[i];
        }).join('+') + '=0';
      });

      equations.push(vars[0] + '=1');

      try {
        const sol = nerdamer.solveEquations(equations);
        const values = vars.map(v => {
          const pair = sol.find(p => p[0] === v);
          return pair ? nerdamer(pair[1]).evaluate().text() : '0';
        });
        const fracs = values.map(c => nerdamer(c).toFraction());
        const denoms = fracs.map(f => +f.split('/')[1] || 1);
        const LCM = lcmArr(denoms);
        let ints = fracs.map(f => {
          const [n, d] = f.split('/');
          return Math.round(+n * (LCM / (+d || 1)));
        });
        const GCD = gcdArr(ints);
        ints = ints.map(x => x / GCD);

        const leftStr = ints.slice(0, left.length).map((c, i) => `${c}${left[i]}`).join(" + ");
        const rightStr = ints.slice(left.length).map((c, i) => `${c}${right[i]}`).join(" + ");
        document.getElementById("result").innerText = leftStr + ' → ' + rightStr;
      } catch (e) {
        document.getElementById("result").innerText = "Không thể cân bằng!";
      }
    }
  </script>
</body>
</html>
