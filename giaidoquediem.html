<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8"/>
<script src="auth.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gi·∫£i ƒê·ªë Que Di√™m</title>
<style>
  :root{--bg:#0f1115;--panel:#171a21;--muted:#2a2f3a;--accent:#ff8c00;--text:#e6e6e6;--good:#22c55e;--bad:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh}
  .sidebar{width:240px;background:var(--panel);padding:16px;overflow-y:auto}
  .sidebar h2{font-size:18px;margin:8px 0 12px}
  details summary{cursor:pointer;padding:8px 10px;background:var(--muted);border-radius:8px;margin:6px 0;font-weight:600}
  .submenu{padding:6px 2px}
  .submenu button{display:block;width:100%;padding:8px 10px;margin:4px 0;border:1px solid transparent;background:#222733;color:var(--text);border-radius:8px;cursor:pointer;text-align:left}
  .submenu button:hover{background:#2c3443}
  .submenu button.active{background:#ff8c00;color:#000;font-weight:700}
  .main{flex:1;text-align:center;padding:20px;max-width:1400px;margin:0 auto}
  h1{margin:6px 0 10px}
  .status{margin:6px 0 14px;font-size:14px;opacity:.9}
  .badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#242b38;margin:2px;font-weight:600}
  .puzzle{display:flex;justify-content:center;align-items:center;gap:18px;flex-wrap:wrap;margin:20px auto;padding:22px;border-radius:12px;background:#0e131c;min-height:160px}
  .digit{position:relative;width:90px;height:150px;margin:6px}
  .segment{position:absolute;background:#1f2631;border-radius:10px;cursor:pointer;transition:all .12s ease}
  .segment.on{background:var(--accent);box-shadow:0 0 10px var(--accent),0 0 22px #a55300}
  .a{top:0;left:16px;width:58px;height:12px}
  .b{top:12px;right:0;width:12px;height:58px}
  .c{bottom:12px;right:0;width:12px;height:58px}
  .d{bottom:0;left:16px;width:58px;height:12px}
  .e{bottom:12px;left:0;width:12px;height:58px}
  .f{top:12px;left:0;width:12px;height:58px}
  .g{top:70px;left:16px;width:58px;height:12px}
  .op{font-size:60px;line-height:1}
  .controls button{margin:6px;padding:10px 16px;border:1px solid #2f3847;border-radius:10px;font-size:16px;cursor:pointer;background:#1d2330;color:var(--text)}
  .controls button:hover{background:#252e40}
  .toast{padding:8px 12px;border-radius:10px;display:inline-block;font-weight:600}
  .toast.good{background:rgba(34,197,94,.15);border:1px solid var(--good)}
  .toast.bad{background:rgba(239,68,68,.12);border:1px solid var(--bad)}
  #answerBox{display:none;}
  .timerControls{margin:12px 0}
  #countdown{margin-left:10px;font-weight:bold}
  #countdown.red{color:var(--bad);}
  #timeInput{width:60px;text-align:center;}
  .menu-toggle{display:none;font-size:26px;cursor:pointer;padding:10px 16px;background:#171a21;color:#fff;border:none;}
  @media (max-width: 768px) {
    .sidebar {position: fixed;top: 0; left: -260px; bottom: 0;height: 100%;z-index: 1000;transition: left 0.3s ease;}
    .sidebar.open {left: 0;}
    .menu-toggle {display:block;}
    body {flex-direction: column;}
    .main {width: 100%;padding: 10px;}
  }
  .overlay {display:none;position: fixed;top:0; left:0; right:0; bottom:0;background: rgba(0,0,0,0.5);z-index: 900;}
  .overlay.show { display:block; }
</style>
</head>
<body>
  <div class="main">
    <h1>TR√í CH∆†I HS TI·ªÇU H·ªåC "GI·∫¢I ƒê·ªê QUE DI√äM"</h1>
    <div class="status">
      <span class="badge">Y√™u c·∫ßu: di chuy·ªÉn ƒë√∫ng <b>1 que</b> (t·ª©c l√† <b>t·∫Øt 1</b> v√† <b>b·∫≠t 1</b>)</span>
      <span class="badge" id="moveBadge">ƒê√£ thay ƒë·ªïi: 0/2</span>
    </div>

    <div class="puzzle" id="puzzle"></div>

    <div class="timerControls">
      <label for="timeInput">Nh·∫≠p th·ªùi gian ch∆°i </label>
      <input type="number" id="timeInput" value="15" />
      <span>Gi√¢y</span>
      <button onclick="startTimer()">B·∫Øt ƒë·∫ßu</button>
      <span id="countdown"></span>
    </div>

    <div class="controls">
      <button onclick="newPuzzle()">C√¢u ƒë·ªë m·ªõi</button>
      <button onclick="check()">Ki·ªÉm tra</button>
      <button onclick="resetPuzzle()">Reset</button>
      <button id="btnAnswer" onclick="showAnswer()" style="display:none">Xem ƒë√°p √°n</button>
      <span id="inlineAnswer" style="margin-left:12px; font-size:16px; color:#ff8c00;"></span>
    </div>

    <div id="toast" class="status"></div>
  </div>

<script>
const soundCorrect = new Audio("correct.mp3");
const soundWrong = new Audio("wrong.mp3");

const digitSegments={0:["a","b","c","d","e","f"],1:["b","c"],2:["a","b","g","e","d"],3:["a","b","g","c","d"],
4:["f","g","b","c"],5:["a","f","g","c","d"],6:["a","f","g","c","d","e"],7:["a","b","c"],8:["a","b","c","d","e","f","g"],9:["a","b","c","d","f","g"]};

let mode="addsub",param=20,currentPuzzle=null,initialHTML=null;
let timer=null,timeLeft=0;

function $(s){return document.querySelector(s)}
function el(tag,cls,txt){const e=document.createElement(tag);if(cls)e.className=cls;if(txt!=null)e.textContent=txt;return e}
function randInt(n){return Math.floor(Math.random()*n)}

function createDigit(num){
  const digit=el("div","digit");
  ["a","b","c","d","e","f","g"].forEach(seg=>{
    const s=el("div","segment "+seg);
    if(digitSegments[num]?.includes(seg)) s.classList.add("on");
    s.addEventListener("click",()=>onToggle(s));
    digit.appendChild(s);
  });
  return digit;
}
function renderPuzzle(expr){
  const wrap=$("#puzzle"); wrap.innerHTML="";
  expr.forEach(ch=>{
    if(!isNaN(ch)) wrap.appendChild(createDigit(parseInt(ch,10)));
    else wrap.appendChild(el("span","op",ch));
  });
  initialHTML=wrap.innerHTML;
  updateMoveBadge();
}
function getDigitFromDOM(digitDiv){
  const active=[...digitDiv.querySelectorAll('.segment.on')].map(s=>s.classList[1]).sort();
  for(let n=0;n<=9;n++){const target=[...digitSegments[n]].sort();
    if(active.length===target.length&&active.every((v,i)=>v===target[i])) return n;}
  return null;
}
function isValidDigit(digitDiv){return getDigitFromDOM(digitDiv)!==null;}
function groupNumbers(tokens){const out=[];let acc="";for(const t of tokens){if(typeof t==="number"){acc+=String(t);} else{if(acc!==""){out.push(Number(acc));acc="";} out.push(t);} }if(acc!=="") out.push(Number(acc));return out;}
function parseExpressionFromDOM(){
  const raw=[...$("#puzzle").childNodes].map(node=>{
    if(node.classList&&node.classList.contains('digit')) return getDigitFromDOM(node);
    return node.textContent.trim();
  });
  if(raw.includes(null)) return null;
  const eqIndex=raw.indexOf("="); if(eqIndex===-1) return null;
  const left=groupNumbers(raw.slice(0,eqIndex)), right=groupNumbers(raw.slice(eqIndex+1));
  if(left.length!==3||typeof left[0]!=="number"||typeof left[2]!=="number") return null;
  if(right.length!==1||typeof right[0]!=="number") return null;
  let [A,op,B]=left, R=right[0]; if(op==="√ó")op="*"; if(op==="√∑")op="/";
  return {A,op,B,R};
}
function makeCorrectExpr(){
  let a,b,res,expr;
  while(true){
    a=randInt(param)+1; b=randInt(param)+1;
    const op=Math.random()>0.5?"+":"-";
    res=op==="+"?a+b:a-b;
    if(res<0||res>param) continue;
    expr=[...String(a),op,...String(b),"=",...String(res)];
    break;
  }
  return expr;
}
function newPuzzle(){
  const correctExpr = makeCorrectExpr();
  renderPuzzle(correctExpr);
  const originalStr = correctExpr.join("");

  const segs = [...document.querySelectorAll('#puzzle .segment')];
  const candidates = [];
  for(let i=0;i<segs.length;i++){
    const offSeg=segs[i];
    if(!offSeg.classList.contains('on')) continue;
    offSeg.classList.remove('on');
    for(let j=0;j<segs.length;j++){
      if(i===j) continue;
      const onSeg=segs[j];
      if(onSeg.classList.contains('on')) continue;
      onSeg.classList.add('on');

      if([...document.querySelectorAll('#puzzle .digit')].every(isValidDigit)){
        const parsed=parseExpressionFromDOM();
        if(parsed){
          const {A,op,B,R}=parsed;let L;
          switch(op){case '+':L=A+B;break;case '-':L=A-B;break;}
          const ok=Math.abs(L-R)<1e-9;
          const newStr=$("#puzzle").innerText.replace(/\s+/g,'');
          if(!ok && newStr!==originalStr){
            candidates.push($("#puzzle").innerHTML);
          }
        }
      }
      onSeg.classList.remove('on');
    }
    offSeg.classList.add('on');
  }
  if(candidates.length>0){
    $("#puzzle").innerHTML=candidates[randInt(candidates.length)];
  }else{
    renderPuzzle(correctExpr);
  }
  initialHTML=$("#puzzle").innerHTML;
  updateMoveBadge();
}
function snapshotStates(){const temp=document.createElement('div');temp.innerHTML=initialHTML;const init=[...temp.querySelectorAll('.segment')].map(s=>s.classList.contains('on'));const now=[...document.querySelectorAll('#puzzle .segment')].map(s=>s.classList.contains('on'));const initOn=init.filter(Boolean).length, nowOn=now.filter(Boolean).length;let diff=0;for(let i=0;i<init.length;i++) if(init[i]!==now[i]) diff++;return{diff,deltaOn:nowOn-initOn};}
function updateMoveBadge(){const {diff,deltaOn}=snapshotStates();$("#moveBadge").textContent=`ƒê√£ thay ƒë·ªïi: ${diff}/2`+(deltaOn===0?"":` (l·ªách ${(deltaOn>0?"+":""}${deltaOn})`);}
function onToggle(seg){seg.classList.toggle('on');const {diff,deltaOn}=snapshotStates();if(diff>2){seg.classList.toggle('on');toast('B·∫°n ch·ªâ ƒë∆∞·ª£c thay ƒë·ªïi 2 ƒëo·∫°n.',true);return;}updateMoveBadge();}
function toast(msg,isBad=false){$("#toast").innerHTML=msg?`<span class="toast ${isBad?'bad':'good'}">${msg}</span>`:"";}
function resetPuzzle(){$("#puzzle").innerHTML=initialHTML;updateMoveBadge();toast('');}
function check(){const {diff,deltaOn}=snapshotStates();if(diff!==2||deltaOn!==0){toast('‚ùå B·∫°n ph·∫£i t·∫Øt 1 v√† b·∫≠t 1 que.',true);soundWrong.play();return;}const parsed=parseExpressionFromDOM();if(!parsed){toast('Sai bi·ªÉu th·ª©c.',true);soundWrong.play();return;}const {A,op,B,R}=parsed;let L;switch(op){case '+':L=A+B;break;case '-':L=A-B;break;}const ok=Math.abs(L-R)<1e-9;toast(ok?'üéâ Ch√≠nh x√°c!':'‚ùå Sai r·ªìi!',!ok);if(ok) soundCorrect.play(); else soundWrong.play();}
function startTimer(){clearInterval(timer);timeLeft=parseInt($("#timeInput").value)||0;$("#countdown").textContent=timeLeft>0?timeLeft+'s':'';if(timeLeft>0){timer=setInterval(()=>{timeLeft--;$("#countdown").textContent=timeLeft+'s';if(timeLeft<=0){clearInterval(timer);$("#countdown").textContent='H·∫øt gi·ªù!';check();}},1000);}}
newPuzzle();
</script>
</body>
</html>
