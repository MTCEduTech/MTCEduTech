<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
 <script src="auth.js"></script>
<title>üéì Tr·ª£ l√Ω ·∫£o d·∫°y h·ªçc MTCEduTech</title>

<script>
window.MathJax = {
  tex: {
    inlineMath: [['\\(', '\\)']],
    displayMath: [['\\[', '\\]']]
  },
  chtml: {
    fontURL: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2'
  },
  startup: {
    typeset: false // ƒë·ªÉ m√¨nh ch·ªß ƒë·ªông g·ªçi typesetPromise()
  }
};
</script>

<script id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"> 
</script>

<style>
  /* [CSS C·ª¶A B·∫†N] Gi·ªØ nguy√™n ph·∫ßn CSS hi·ªán t·∫°i ƒë·ªÉ giao di·ªán kh√¥ng ƒë·ªïi */
  body {
    font-family: "Segoe UI", sans-serif;
    background: linear-gradient(135deg, #c9e8ff, #e7ffe7);
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
  }
  #chatbox {
    width: 90%; max-width: 700px; background: white; border-radius: 20px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.15); padding: 20px; display: flex;
    flex-direction: column; transition: transform 0.3s ease;
  }
  #chatbox:hover { transform: translateY(-5px); }
  h2 { text-align: center; color: #0078d7; margin-bottom: 10px; }
  #messages {
    flex: 1; height: 400px; overflow-y: auto; background: #f7faff;
    border-radius: 10px; padding: 15px; border: 1px solid #dde4f0; margin-bottom: 10px;
  }
  .msg { margin: 8px 0; padding: 10px 15px; border-radius: 15px; max-width: 80%; animation: fadeIn 0.4s ease; }
  .user { background: #daf0ff; align-self: flex-end; color: #005a9e; }
  .bot { background: #e2ffe3; color: #146c2e; align-self: flex-start; }
  #input-area { display: flex; gap: 10px; }
  input { flex: 1; padding: 12px; font-size: 16px; border-radius: 10px; border: 1px solid #ccc; transition: 0.2s; }
  input:focus { border-color: #0078d7; box-shadow: 0 0 5px #0078d7; outline: none; }
  button {
    background: #0078d7; color: white; border: none; border-radius: 10px;
    padding: 12px 18px; font-size: 16px; cursor: pointer; transition: background 0.3s ease, transform 0.2s;
  }
  button:hover { background: #005fa3; transform: scale(1.05); }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  #loading { text-align: center; color: gray; font-style: italic; }
</style>

<link rel="stylesheet" href="menu.css">
</head>
<body>

<div id="chatbox">
  <h2>üéì Tr·ª£ l√Ω ·∫£o MTCEduTech h·ªó tr·ª£ d·∫°y & h·ªçc</h2>
  <div id="messages"></div>

  <div id="input-area">
    <input type="file" id="image-upload" accept="image/*" style="display: none;">
    
    <button id="upload-button" onclick="document.getElementById('image-upload').click()" title="G·ª≠i ·∫£nh">üñºÔ∏è</button>
    
    <span id="file-status" style="padding: 12px 0 12px 10px; color: #0078d7; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; display: none; align-self: center;"></span>
    
    <input type="text" id="prompt" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..." onkeypress="if(event.key==='Enter')sendMessage()">
    <button onclick="sendMessage()">G·ª≠i</button>
    
   <button id="export-button" onclick="exportToWord()" title="Xu·∫•t n·ªôi dung chat ra file Word" style="background: #0078d7;">Download Word</button>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
  const API_KEY = "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";

  let pastedImageFile = null;

  const getBase64 = (file) => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
      reader.onerror = (error) => reject(error);
  });
  
  document.addEventListener('DOMContentLoaded', () => {
    const imageInput = document.getElementById("image-upload");
    const fileStatus = document.getElementById("file-status");
    
    if (imageInput) {
        imageInput.addEventListener('change', () => {
            if (imageInput.files.length > 0) {
                pastedImageFile = imageInput.files[0];
                fileStatus.textContent = `‚úÖ ${pastedImageFile.name}`;
                fileStatus.style.display = 'block';
            } else {
                pastedImageFile = null;
                fileStatus.textContent = '';
                fileStatus.style.display = 'none';
            }
        });
    }

    document.addEventListener('paste', handlePaste);
    document.getElementById("prompt").focus();
  });

  function handlePaste(event) {
    const items = (event.clipboardData || event.originalEvent.clipboardData).items;
    const fileStatus = document.getElementById("file-status");
    
    for (const item of items) {
        if (item.type.indexOf("image") !== -1) {
            const blob = item.getAsFile();
            if (blob) {
                pastedImageFile = blob; 
                fileStatus.textContent = `üñºÔ∏è ƒê√£ d√°n ·∫£nh t·ª´ Clipboard (Lo·∫°i: ${blob.type.split('/')[1]})`;
                fileStatus.style.display = 'block';
                event.preventDefault(); 
                return;
            }
        }
    }
  }

  async function sendMessage() {
    const promptInput = document.getElementById("prompt");
    const fileStatus = document.getElementById("file-status");
    const prompt = promptInput.value.trim();
    const imageFile = pastedImageFile; 

    if (!prompt && !imageFile) return;

    let finalPrompt = prompt;
    if (!finalPrompt && imageFile) {
        finalPrompt = "H√£y gi·∫£i b√†i t·∫≠p, ho·∫∑c tr·∫£ l·ªùi c√¢u h·ªèi trong ·∫£nh n√†y.";
    }
    
    const messagesDiv = document.getElementById("messages");

    const userMsg = document.createElement("div");
    userMsg.className = "msg user";
    userMsg.textContent = finalPrompt + (imageFile ? ` [ƒê√£ g·ª≠i k√®m ·∫£nh: ${imageFile.name || 't·ª´ Clipboard'}]` : '');
    messagesDiv.appendChild(userMsg);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    promptInput.value = "";
    
    pastedImageFile = null; 
    fileStatus.textContent = ''; 
    fileStatus.style.display = 'none'; 
    
    const loading = document.createElement("div");
    loading.id = "loading";
    loading.textContent = "ƒêang suy nghƒ©...";
    messagesDiv.appendChild(loading);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    let base64Image = null;
    if (imageFile) {
        try {
            base64Image = await getBase64(imageFile);
        } catch (error) {
            messagesDiv.removeChild(loading);
            alert("L·ªói khi ƒë·ªçc file ·∫£nh.");
            return;
        }
    }

    const userContent = [];

    if (finalPrompt) {
        userContent.push({ type: "text", text: finalPrompt });
    }

    if (base64Image) {
        userContent.push({
            type: "image_url",
            image_url: {
                url: base64Image
            }
        });
    }

    const systemContent = `B·∫°n l√† tr·ª£ l√Ω d·∫°y h·ªçc MTCEduTech. 
      Nhi·ªám v·ª• c·ªßa b·∫°n:
      - Gi·∫£i th√≠ch ch√≠nh x√°c ki·∫øn th·ª©c To√°n, L√Ω, H√≥a c·∫•p THCS b·∫±ng ng√¥n ng·ªØ d·ªÖ hi·ªÉu.
      - QUAN TR·ªåNG: Khi c√≥ y√™u c·∫ßu vi·∫øt ho·∫∑c c√¢n b·∫±ng ph∆∞∆°ng tr√¨nh h√≥a h·ªçc, b·∫°n PH·∫¢I ƒê·∫¢M B·∫¢O ph∆∞∆°ng tr√¨nh ƒë∆∞·ª£c C√ÇN B·∫∞NG CH√çNH X√ÅC (b·∫£o to√†n nguy√™n t·ª≠) v√† ƒë√∫ng h√≥a tr·ªã. LU√îN KI·ªÇM TRA L·∫†I C√ÇN B·∫∞NG TR∆Ø·ªöC KHI TR·∫¢ L·ªúI.
      - QUY T·∫ÆC PH·∫¢N ·ª®NG H√ìA H·ªåC v√† C√¢n b·∫±ng M·∫´u:
          - Axit Sulfuric ƒê·∫∂C N√ìNG: Ch·ªâ s·ª≠ d·ª•ng h·ªá s·ªë m·∫´u ch√≠nh x√°c sau: \\[ 2Fe + 6H_2SO_4 \rightarrow Fe_2(SO_4)_3 + 3SO_2 + 6H_2O \\]
          - QUY T·∫ÆC TH·ª§ ƒê·ªòNG H√ìA: Kim lo·∫°i Fe, Al, Cr KH√îNG ph·∫£n ·ª©ng v·ªõi HNO3 ƒë·∫∑c ngu·ªôi v√† H2SO4 ƒë·∫∑c ngu·ªôi.
          - QUY T·∫ÆC ƒêI·ªÄU CH·∫æ: \\(CaC_2\\) ph·∫£n ·ª©ng v·ªõi n∆∞·ªõc t·∫°o ra \\(C_2H_2\\) (Axetilen), kh√¥ng ph·∫£i \\(C_2H_4\\).
          - V√†ng (Au) v·ªõi N∆∞·ªõc C∆∞·ªùng Th·ªßy: V√≠ d·ª•: \\[ Au + 4HCl + HNO_3 \rightarrow H[AuCl_4] + NO + 2H_2O \\]
      - Khi c√≥ c√¥ng th·ª©c To√°n, H√≥a, L√Ω th√¨ tr·∫£ v·ªÅ ·ªü d·∫°ng LaTeX, v√≠ d·ª•: \\[ a^2 + b^2 = c^2 \\].
      - N·∫øu h·ªçc sinh vi·∫øt sai ph∆∞∆°ng tr√¨nh, h√£y g·ª£i √Ω l·∫°i ph∆∞∆°ng tr√¨nh ƒë√∫ng, n√™u r√µ ƒëi·ªÅu ki·ªán (lo√£ng/ƒë·∫∑c) v√† C√ÇN B·∫∞NG CH√çNH X√ÅC.
      - Tr·∫£ l·ªùi ng·∫Øn g·ªçn, k√®m v√≠ d·ª• minh h·ªça th·ª±c t·∫ø.`;

    try {
      const response = await fetch("https://mtc-proxy.onrender.com/api/chat", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${API_KEY}`
        },
        body: JSON.stringify({
          model: "gpt-4o-mini",
          messages: [
            { role: "system", content: systemContent },
            { role: "user", content: userContent }
          ]
        })
      });

      if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`L·ªói API (${response.status}): ${errorData.error?.message || response.statusText}`);
      }

      const data = await response.json();
      messagesDiv.removeChild(loading);

      let reply = data.choices?.[0]?.message?.content || "Xin l·ªói, t√¥i ch∆∞a hi·ªÉu c√¢u h·ªèi c·ªßa b·∫°n. H√£y th·ª≠ g·ª≠i l·∫°i n·ªôi dung v√† h√¨nh ·∫£nh.";
      reply = reply
        .replace(/```/g, '')
        .replace(/###/g, '<br><b>')
        .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');

      const botMsg = document.createElement("div");
      botMsg.className = "msg bot";
      botMsg.innerHTML = reply;
      messagesDiv.appendChild(botMsg);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      if (window.MathJax) {
        MathJax.typesetClear && MathJax.typesetClear();
        MathJax.typesetPromise([botMsg]).catch((err) => console.error(err.message));
      }

      messagesDiv.scrollTop = messagesDiv.scrollHeight;

    } catch (error) {
      messagesDiv.removeChild(loading);
      const errorMsg = document.createElement("div");
      errorMsg.className = "msg bot";
      errorMsg.textContent = `‚ö†Ô∏è L·ªói k·∫øt n·ªëi ho·∫∑c API: ${error.message}`; 
      messagesDiv.appendChild(errorMsg);
    }
  }

async function exportToWord() {
  const messagesDiv = document.getElementById("messages");
  if (!messagesDiv.children.length) {
    alert("Kh√¥ng c√≥ n·ªôi dung ƒë·ªÉ xu·∫•t.");
    return;
  }

  const exportButton = document.getElementById("export-button");
  exportButton.disabled = true;
  exportButton.textContent = "ƒêang t·∫°o file...";

  // üßÆ Ch·ªù MathJax render xong h·∫øt (ƒë·ªÉ c√¥ng th·ª©c l·ªõn hi·ªÉn th·ªã)
  if (window.MathJax && MathJax.typesetPromise) {
    await MathJax.typesetPromise([messagesDiv]);
  }

  // Sao ch√©p to√†n b·ªô v√πng chat
  const clonedDiv = messagesDiv.cloneNode(true);

  // ‚úÖ CHUY·ªÇN CH·ªà S·ªê D∆Ø·ªöI v√† CH·ªà S·ªê TR√äN trong c√°c c√¥ng th·ª©c h√≥a h·ªçc
  let htmlContent = clonedDiv.innerHTML;

  htmlContent = htmlContent
    // v√≠ d·ª•: H2O -> H<sub>2</sub>O, Cl4 -> Cl<sub>4</sub>
    .replace(/([A-Za-z])(\d+)/g, '$1<sub>$2</sub>')
    // v√≠ d·ª•: ^2 -> <sup>2</sup>
    .replace(/\^(\d+)/g, '<sup>$1</sup>');

  // CSS ƒë·ªÉ hi·ªÉn th·ªã ƒë·∫πp trong Word
  const css = `
    body { font-family: 'Times New Roman', serif; margin: 25px; font-size: 12pt; }
    .msg-box { border: 1px solid #ccc; padding: 10px 14px; border-radius: 6px; margin-bottom: 15px; }
    .user { background: #eef6ff; }
    .bot { background: #f2fff0; }
    sub { vertical-align: sub; font-size: 0.8em; }
    sup { vertical-align: super; font-size: 0.8em; }
  `;

  const html = `
    <html><head><meta charset="utf-8"><style>${css}</style></head>
    <body>${htmlContent}</body></html>
  `;

  // Xu·∫•t ra file Word
  const blob = new Blob(['\ufeff', html], { type: "application/msword" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "MTCEduTech_KetQua.doc";
  a.click();

  URL.revokeObjectURL(url);
  exportButton.disabled = false;
  exportButton.textContent = "Download Word";
  alert("‚úÖ File Word ƒë√£ t·∫°o xong ‚Äî ch√∫c b·∫°n th√†nh c√¥ng!");
}

</script>

<!-- N√∫t to√†n m√†n h√¨nh c·ªë ƒë·ªãnh -->
<div style="
  position: fixed;
  bottom: 20px;
  left: 20px;
  z-index: 9999;
  display: flex;
  flex-direction: row;
  gap: 10px;
">
  <button onclick="openFullscreen()" style="
    padding: 10px 16px;
    font-size: 14px;
    background: #00BFFF;
    border: none;
    border-radius: 6px;
    color: white;
    cursor: pointer;
  ">üîç Xem Full m√†n h√¨nh</button>

  <button onclick="exitFullscreen()" style="
    padding: 10px 16px;
    font-size: 14px;
    background: #FF6347;
    border: none;
    border-radius: 6px;
    color: white;
    cursor: pointer;
  ">‚ùå Tho√°t Full m√†n h√¨nh</button>
</div>
<script>
  function openFullscreen() {
    const elem = document.documentElement;
    if (elem.requestFullscreen) {
      elem.requestFullscreen();
    } else if (elem.webkitRequestFullscreen) { /* Safari */
      elem.webkitRequestFullscreen();
    } else if (elem.msRequestFullscreen) { /* IE11 */
      elem.msRequestFullscreen();
    }
  }

  function exitFullscreen() {
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.webkitExitFullscreen) { /* Safari */
      document.webkitExitFullscreen();
    } else if (document.msExitFullscreen) { /* IE11 */
      document.msExitFullscreen();
    }
  }
</script>

<div style="
  position: fixed;
  bottom: 10px;
  right: 20px;
  z-index: 1001;
  display: flex;
  flex-direction: column;
  gap: 10px;
  align-items: flex-end;
">
    <button onclick="window.location.href='index.html'" style="
    background-color: red;
    color: white;
    font-weight: bold;
    border: none;
    padding: 10px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    width: 220px;
  ">
    üè† V·ªÄ TRANG CH·ª¶
  </button>
</div>

<!-- N√∫t c·ªë ƒë·ªãnh c√≥ th·ªÉ k√©o -->
<button class="menu-toggle draggable"><img src="TC.png" alt="Menu" class="menu-icon"></button>
<!-- Overlay -->
<div id="overlay" class="overlay"></div>
<!-- Menu -->
<div id="sideMenu" class="side-menu">
  <a href="../index.html">üè† Trang ch·ªß</a>
  <a href="../vong_quay_so.html">üéØ V√≤ng quay s·ªë</a>
  <a href="../vong_quay_ten.html">üë• V√≤ng quay t√™n</a>
  <a href="../Ai_la_trieu_phu.html">üí∞ Ai l√† tri·ªáu ph√∫</a>
  <a href="../O_Chu_bi_mat.html">üß© T√¨m √î ch·ªØ b√≠ m·∫≠t</a>
  <a href="../O_Chu_tron_tim.html">üîç Tinh m·∫Øt t√¨m t·ª´</a>
  <a href="../doan_tu.html">üî§ Game suy ƒëo√°n t·ª´</a>
  <a href="../soan_cau_hoi.html">üìù So·∫°n ƒë·ªÅ TN Tick ch·ªçn + ch·∫•m ƒëi·ªÉm</a> 
  <a href="../sukienVN.html">üìñ Theo d√≤ng s·ª± ki·ªán - l·ªãch s·ª≠ VN</a> 
  <a href="../fx-570VN Plus.html">üìü Gi·∫£ l·∫≠p Fx-570 + B·∫£ng tu·∫ßn ho√†n NTHH</a>
  <a href="../Caro.html">üéÆ Game Caro + Music</a>
  <a href="#" onclick="toggleMenu()">‚ùå ƒê√≥ng Menu</a>
</div>

<script src="menu.js"></script> 
<script src="chao_name.js"></script>
</body>
</html>




